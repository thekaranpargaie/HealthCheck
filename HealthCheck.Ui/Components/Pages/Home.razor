@page "/"
@rendermode InteractiveServer
@implements IDisposable
@using System.Net.Http.Json
@using HealthCheck.Main.Models

<PageTitle>Health Dashboard</PageTitle>

<style>
    .dashboard-container {
        display: flex;
        flex-wrap: wrap;
        gap: 2rem;
        justify-content: flex-start;
        margin-top: 2rem;
    }

    .health-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        padding: 1.5rem 2rem 1rem 2rem;
        min-width: 320px;
        max-width: 350px;
        display: flex;
        flex-direction: column;
        margin-bottom: 1rem;
    }

    .status-pill {
        display: inline-block;
        padding: 0.3em 0.8em;
        border-radius: 6px; /* rectangular rounded corner */
        font-weight: 600;
        font-size: 0.95em;
        color: #fff;
        margin-bottom: 0.5em;
    }

    .status-healthy {
        background: #28a745;
    }

    .status-unhealthy {
        background: #dc3545;
    }

    .status-unknown {
        background: #6c757d;
    }

    .history-row {
        display: flex;
        gap: 0.4em;
        margin-top: 1.2em;
        justify-content: flex-start;
        align-items: center;
    }

    .history-pill {
        width: 16px;
        height: 16px;
        border-radius: 4px; /* square with slightly rounded corners */
        display: inline-block;
        border: 1px solid #e0e0e0;
    }

    .pill-healthy {
        background: #28a745;
    }

    .pill-unhealthy {
        background: #dc3545;
    }

    .pill-missing {
        background: #d3d3d3;
    }

    .service-title {
        font-size: 1.2em;
        font-weight: 700;
        margin-bottom: 0.5em;
    }

    .last-checked {
        font-size: 0.95em;
        color: #888;
        margin-bottom: 0.5em;
    }

    .description {
        font-size: 1em;
        margin-bottom: 0.5em;
    }

    .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .countdown-circle {
        background-color: #007bff;
        color: white;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        font-size: 1rem;
        animation: pulse 1s infinite;
    }

    @@keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7);
        }

        70% {
            box-shadow: 0 0 0 10px rgba(0, 123, 255, 0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(0, 123, 255, 0);
        }
    }
</style>


<div class="top-bar">
    <h1 style="margin-bottom: 0;">Health Dashboard</h1>
    <div class="countdown-circle" title="Next update in @secondsRemaining seconds">
        @secondsRemaining
    </div>
</div>

@if (isLoading)
{
    <p>Loading health data...</p>
}
else if (errorMessage != null)
{
    <p class="text-danger">@errorMessage</p>
}
else
{
    <div class="dashboard-container">
        @foreach (var group in groupedResults)
        {
            var latest = group.Value.LastOrDefault();
            var statusClass = latest?.IsHealthy == true ? "status-healthy" : "status-unhealthy";
            var statusText = latest?.IsHealthy == true ? "Healthy" : "Unhealthy";
            <div class="health-card">
                <div class="service-title">@group.Key</div>
                <span class="status-pill @statusClass">@statusText</span>
                <div class="last-checked">
                    Last checked: @latest?.Timestamp.ToLocalTime().ToString("g")
                </div>
                <div class="description">@latest?.Description</div>
                <div class="history-row">
                    @foreach (var pill in GetHistoryPills(group.Value))
                    {
                        <span class="history-pill @pill.CssClass" title="@pill.Tooltip"></span>
                    }
                </div>
            </div>
        }
    </div>
}

@code {
    private List<HealthCheckPingResult> results = new();
    private Dictionary<string, List<HealthCheckPingResult>> groupedResults = new();
    private bool isLoading = true;
    private string? errorMessage;
    private CancellationTokenSource _cts = new();
    private int secondsRemaining = 60;
    private System.Threading.Timer? countdownTimer;
    private const int PillsToShow = 24;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        countdownTimer = StartCountdownTimer(); // ✅ FIXED
        _ = RunPeriodicUpdate(_cts.Token);
    }

    private System.Threading.Timer StartCountdownTimer()
    {
        return new System.Threading.Timer(_ =>
        {
            if (secondsRemaining > 0)
                secondsRemaining--;
            else
                secondsRemaining = 60;

            InvokeAsync(StateHasChanged);
        }, null, 0, 1000);
    }

    private async Task RunPeriodicUpdate(CancellationToken token)
    {
        var timer = new PeriodicTimer(TimeSpan.FromMinutes(1));

        try
        {
            while (await timer.WaitForNextTickAsync(token))
            {
                await InvokeAsync(async () =>
                {
                    await LoadData();
                    StateHasChanged();
                });
            }
        }
        catch (OperationCanceledException)
        {
            // Gracefully handle cancellation
        }
    }

    private async Task LoadData()
    {
        isLoading = true;
        errorMessage = null;
        try
        {
            var http = new HttpClient { BaseAddress = new Uri("http://healthcheck-api:5001/") };
            results = await http.GetFromJsonAsync<List<HealthCheckPingResult>>("api/healthchecks") ?? new();
            groupedResults = results
                .GroupBy(r => r.ServiceKey)
                .ToDictionary(g => g.Key, g => g.OrderBy(x => x.Timestamp).ToList());
        }
        catch (Exception ex)
        {
            errorMessage = "Failed to load health data: " + ex.Message;
        }
        isLoading = false;
    }

    private IEnumerable<(string CssClass, string Tooltip)> GetHistoryPills(List<HealthCheckPingResult> pings)
    {
        var recent = pings
            .OrderByDescending(p => p.Timestamp)
            .Take(PillsToShow)
            .OrderBy(p => p.Timestamp)
            .ToList();

        int missing = PillsToShow - recent.Count;

        for (int i = 0; i < missing; i++)
        {
            yield return ("pill-missing", "No data");
        }

        foreach (var ping in recent)
        {
            yield return (
                ping.IsHealthy ? "pill-healthy" : "pill-unhealthy",
                $"{ping.Timestamp.ToLocalTime():g} - {(ping.IsHealthy ? "Healthy" : "Unhealthy")}"
            );
        }
    }

    public void Dispose()
    {
        _cts.Cancel();
        _cts.Dispose();
        countdownTimer?.Dispose();
    }
}